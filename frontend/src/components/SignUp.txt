import React, { useState } from "react";
import { useNavigate } from "react-router-dom";
import logoAmeoWhite from "../assets/icon/icon-cats-white.png"

const provinces = [
  { value: "Hà Nội", label: "Hà Nội" },
  { value: "TP Hồ Chí Minh", label: "TP Hồ Chí Minh" },
  { value: "Đà Nẵng", label: "Đà Nẵng" },
  { value: "Hải Phòng", label: "Hải Phòng" },
  { value: "Cần Thơ", label: "Cần Thơ" },
  { value: "Nam Định", label: "Nam Định" },
  // Thêm các tỉnh/thành phố khác vào đây
];

function Signup() {
  const navigate = useNavigate();
  const [formData, setFormData] = useState({
    full_name: "",
    email: "",
    phone: "",
    username: "",
    password: "",
    confirmPassword: "",
    birth_date: "",
    gender: "Nam",
    user_type: "Sinh viên",
    address: "",
    avatar: null,
  });

  const [focusedField, setFocusedField] = useState('');
  const [error, setError] = useState("");

  const handleChange = (e) => {
    const { name, value } = e.target;
  
    setFormData((prevData) => {
      // Nếu giá trị không thay đổi, không cần re-set lại error
      if (prevData[name] === value) return prevData;
  
      return { ...prevData, [name]: value };
    });
  
    // Chỉ kiểm tra lỗi nếu đang nhập vào ô "address"
    if (name === "address") {
      const isValid = provinces.some((p) => p.value === value);
      setError(isValid || value === "" ? "" : "Vui lòng chọn một tỉnh/thành phố hợp lệ.");
    }
  };
  

  const handleFocus = (field) => setFocusedField(field);
  const handleBlur = (field) => setFocusedField(prev => (formData[field] ? prev : ''));

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (formData.password !== formData.confirmPassword) {
      alert("Mật khẩu xác nhận không khớp!");
      return;
    }

    const formDataToSend = new FormData();
    Object.keys(formData).forEach((key) => {
      if (formData[key]) {
        formDataToSend.append(key, formData[key]);
      }
    });

    try {
      const response = await fetch("http://localhost:8000/api/signup/", {
        method: "POST",
        body: formDataToSend,
      });

      const result = await response.json();
      if (response.ok) {
        alert("Đăng ký thành công!");
        navigate("/login");
      } else {
        alert(`Lỗi: ${result.error}`);
      }
    } catch (error) {
      alert("Có lỗi xảy ra. Vui lòng thử lại!");
    }
  };

  return (
    <div style={styles.outerContainer}>
      <div style={styles.leftPanel}>
        <div style={styles.content}>
          <img src={logoAmeoWhite} alt="Ameo Logo" style={styles.logo} />
          <h1 style={styles.logoText}>Ameo</h1>
          <p style={styles.description}>We're barely cats</p>
          <button style={styles.homeButton} onClick={() => navigate("/guest/home")}>
            Khám phá ngay
          </button>
        </div>
      </div>
      
      <div style={styles.rightPanel}>
        <div style={styles.formContainer}>
          <h2 style={styles.title}> Đăng Ký
          </h2>
          <form onSubmit={handleSubmit} style={styles.form}>
            <div style={styles.section}>
              {/* FULL NAME */}
              <div style={styles.inputContainerStyle}>
                <label
                  style={{
                    ...styles.placeholderStyle,
                    ...(focusedField === 'full_name' || formData.full_name ? styles.focusedPlaceholderStyle : {}),
                  }}
                >
                  Họ và tên
                </label>
                <input
                  type="text"
                  name="full_name"
                  value={formData.full_name}
                  onChange={handleChange}
                  onFocus={() => handleFocus('full_name')}
                  onBlur={() => handleBlur('full_name')}
                  style={{
                    ...styles.inputStyle,
                    borderColor: focusedField === 'full_name' ? '#6f3e76' : '#ccc',
                  }}
                  required
                />
              </div>
              {/* BIRTH DATE */}
              <div style={styles.inputContainerStyle}>
                <label
                  style={{
                    ...styles.placeholderStyle,
                    ...(focusedField === 'birth_date' || formData.birth_date ? styles.focusedPlaceholderStyle : {}),
                  }}
                >
                  Ngày sinh
                </label>
                <input
                  type="date"
                  name="birth_date"
                  value={formData.birth_date}
                  onChange={handleChange}
                  onFocus={() => handleFocus('birth_date')}
                  onBlur={() => handleBlur('birth_date')}
                  style={{
                    ...styles.inputStyle,
                    borderColor: focusedField === 'birth_date' ? '#6f3e76' : '#ccc',
                  }}
                />
              </div>

              {/* EMAIL */}
              <div style={styles.inputContainerStyle}>
                <label
                  style={{
                    ...styles.placeholderStyle,
                    ...(focusedField === 'email' || formData.email ? styles.focusedPlaceholderStyle : {}),
                  }}
                >
                  Email
                </label>
                <input
                  type="email"
                  name="email"
                  value={formData.email}
                  onChange={handleChange}
                  onFocus={() => handleFocus('email')}
                  onBlur={() => handleBlur('email')}
                  style={{
                    ...styles.inputStyle,
                    borderColor: focusedField === 'email' ? '#6f3e76' : '#ccc',
                  }}
                  required
                />
              </div>

              {/* PHONE */}
              <div style={styles.inputContainerStyle}>
                <label
                  style={{
                    ...styles.placeholderStyle,
                    ...(focusedField === 'phone' || formData.phone ? styles.focusedPlaceholderStyle : {}),
                  }}
                >
                  Số điện thoại
                </label>
                <input
                  type="text"
                  name="phone"
                  value={formData.phone}
                  onChange={handleChange}
                  onFocus={() => handleFocus('phone')}
                  onBlur={() => handleBlur('phone')}
                  style={{
                    ...styles.inputStyle,
                    borderColor: focusedField === 'phone' ? '#6f3e76' : '#ccc',
                  }}
                  required
                />
              </div>

              {/* USER TYPE */}
              <div style={{ display: "flex", justifyContent: "space-between" }}>
                <select
                  name="user_type"
                  value={formData.user_type}
                  onChange={handleChange}
                  style={{ ...styles.selectStyle, width: "49%" }} // Đảm bảo chia đôi chiều rộng
                >
                  <option value="" disabled>
                    Loại tài khoản
                  </option>
                  <option value="Sinh viên">Sinh viên</option>
                  <option value="Giảng viên">Giảng viên</option>
                </select>

                {/* GENDER */}
                <select
                  name="gender"
                  value={formData.gender}
                  onChange={handleChange}
                  style={{ ...styles.selectStyle, width: "49%" }} // Đảm bảo chia đôi chiều rộng
                >
                  <option value="" disabled>
                    Giới tính
                  </option>
                  <option value="Nam">Nam</option>
                  <option value="Nữ">Nữ</option>
                </select>
              </div>
              
              {/* ADDRESS */}
              <div style={styles.inputContainerStyle}>
                <label
                  style={{
                    ...styles.placeholderStyle,
                    ...(formData.address ? styles.focusedPlaceholderStyle : {}),
                  }}
                >
                  Tỉnh/Thành phố
                </label>
                <input
                  type="text"
                  name="address"
                  list="provinceList"
                  value={formData.address}
                  onChange={handleChange}
                  onFocus={() => setFocusedField("address")}
                  onBlur={() => setFocusedField("")}
                  style={{
                    ...styles.inputStyle,
                    borderColor: focusedField === "address" ? "#6f3e76" : "#ccc", // Viền đổi màu tím khi focus
                  }}
                />
                <datalist id="provinceList">
                  {provinces.map((p) => (
                    <option key={p.value} value={p.value} />
                  ))}
                </datalist>
                {error && <p style={{ color: "red", fontSize: "12px" }}>{error}</p>}
              </div>
              {/* PASSWORD */}
              <div style={styles.inputContainerStyle}>
                <label
                  style={{
                    ...styles.placeholderStyle,
                    ...(focusedField === 'password' || formData.password ? styles.focusedPlaceholderStyle : {}),
                  }}
                >
                  Mật khẩu
                </label>
                <input
                  type="password"
                  name="password"
                  value={formData.password}
                  onChange={handleChange}
                  onFocus={() => handleFocus('password')}
                  onBlur={() => handleBlur('password')}
                  style={{
                    ...styles.inputStyle,
                    borderColor: focusedField === 'password' ? '#6f3e76' : '#ccc',
                  }}
                  required
                />
              </div>

              {/* CONFIRM PASSWORD */}
              <div style={styles.inputContainerStyle}>
                <label
                  style={{
                    ...styles.placeholderStyle,
                    ...(focusedField === 'confirmPassword' || formData.confirmPassword ? styles.focusedPlaceholderStyle : {}),
                  }}
                >
                  Xác nhận mật khẩu
                </label>
                <input
                  type="password"
                  name="confirmPassword"
                  value={formData.confirmPassword}
                  onChange={handleChange}
                  onFocus={() => handleFocus('confirmPassword')}
                  onBlur={() => handleBlur('confirmPassword')}
                  style={{
                    ...styles.inputStyle,
                    borderColor: focusedField === 'confirmPassword' ? '#6f3e76' : '#ccc',
                  }}
                  required
                />
              </div>
            </div>
            
            {/* BUTTON SIGNUP */}
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
              <button type="submit" style={styles.button}>Đăng ký</button>
              <p style={{ marginLeft: "10px", marginBottom: "5px" }}>
                Bạn đã có tài khoản? 
                <a href="/login" style={{ color: "#6f3e76", fontWeight: "bold", textDecoration: "none", marginLeft: "10px" }}>
                  Đăng nhập
                </a>
              </p>
            </div>
          </form>
        </div>
        {/* SVG làm viền */}  
        {/* đường cong 0.25 */}
        <svg 
          style={styles.curve}
          xmlns="http://www.w3.org/2000/svg" 
          viewBox="0 0 1440 320"
        >
          <path 
            fill="#ffffff" 
            fill-opacity="0.25" 
            d="M0,128L30,154.7C60,181,120,235,180,234.7C240,235,300,181,360,165.3C420,149,480,171,540,154.7C600,139,660,85,720,90.7C780,96,840,160,900,165.3C960,171,1020,117,1080,117.3C1140,117,1200,171,1260,208C1320,245,1380,267,1410,277.3L1440,288L1440,0L1410,0C1380,0,1320,0,1260,0C1200,0,1140,0,1080,0C1020,0,960,0,900,0C840,0,780,0,720,0C660,0,600,0,540,0C480,0,420,0,360,0C300,0,240,0,180,0C120,0,60,0,30,0L0,0Z"
          ></path>
        </svg>
        {/* đường cong 0.5 */}
        <svg 
          style={styles.curve}
          xmlns="http://www.w3.org/2000/svg" 
          viewBox="0 0 1440 320"
        >
          <path 
            fill="#ffffff" 
            fill-opacity="0.5" 
            d="M0,96L48,96C96,96,192,96,288,122.7C384,149,480,203,576,197.3C672,192,768,128,864,96C960,64,1056,64,1152,96C1248,128,1344,192,1392,224L1440,256L1440,0L1392,0C1344,0,1248,0,1152,0C1056,0,960,0,864,0C768,0,672,0,576,0C480,0,384,0,288,0C192,0,96,0,48,0L0,0Z"
          ></path>
        </svg>
        {/* đường cong 0.5 */}
        <svg 
          style={styles.curve}
          xmlns="http://www.w3.org/2000/svg" 
          viewBox="0 0 1440 320"
        >
          <path 
            fill="#ffffff" 
            fill-opacity="0.5" 
            d="M0,0L20,37.3C40,75,80,149,120,165.3C160,181,200,139,240,154.7C280,171,320,245,360,266.7C400,288,440,256,480,213.3C520,171,560,117,600,106.7C640,96,680,128,720,122.7C760,117,800,75,840,64C880,53,920,75,960,122.7C1000,171,1040,245,1080,266.7C1120,288,1160,256,1200,218.7C1240,181,1280,139,1320,106.7C1360,75,1400,53,1420,42.7L1440,32L1440,0L1420,0C1400,0,1360,0,1320,0C1280,0,1240,0,1200,0C1160,0,1120,0,1080,0C1040,0,1000,0,960,0C920,0,880,0,840,0C800,0,760,0,720,0C680,0,640,0,600,0C560,0,520,0,480,0C440,0,400,0,360,0C320,0,280,0,240,0C200,0,160,0,120,0C80,0,40,0,20,0L0,0Z"
          ></path>
        </svg>
        {/* đường cong trắng */}
        <svg
          style={styles.curve}
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 1440 320"
        >
          <path
            fill="#ffffff"
            fillOpacity="1"
            d="M0,192L21.8,197.3C43.6,203,87,213,131,197.3C174.5,181,218,139,262,144C305.5,149,349,203,393,192C436.4,181,480,107,524,96C567.3,85,611,139,655,165.3C698.2,192,742,192,785,176C829.1,160,873,128,916,112C960,96,1004,96,1047,122.7C1090.9,149,1135,203,1178,234.7C1221.8,267,1265,277,1309,261.3C1352.7,245,1396,203,1418,181.3L1440,160L1440,0L1418.2,0C1396.4,0,1353,0,1309,0C1265.5,0,1222,0,1178,0C1134.5,0,1091,0,1047,0C1003.6,0,960,0,916,0C872.7,0,829,0,785,0C741.8,0,698,0,655,0C610.9,0,567,0,524,0C480,0,436,0,393,0C349.1,0,305,0,262,0C218.2,0,175,0,131,0C87.3,0,44,0,22,0L0,0Z"
          ></path>
        </svg>
      </div>
    </div>
  );
}

const styles = {
  outerContainer: {
    display: "flex",
    height: "100vh",  // Dùng minHeight thay vì height để tránh thừa khoảng trống khi nội dung lớn hơn viewport
    overflow: "hidden",
    position: "relative", // Đảm bảo phần con bị giới hạn trong khung cha
  },
  leftPanel: {
    width: "60%",
    position: "relative",
    backgroundColor: "#6f3e76",
    display: "flex",
    justifyContent: "center",
    alignItems: "center",
  },
  content: {
    textAlign: "center",
    color: "white",
  },
  logo: {
    width: "100px",
    height: "100px",
    marginBottom: "10px",
  },
  logoText: {
    fontSize: "28px",
    fontWeight: "bold",
  },
  description: {
    fontSize: "16px",
    marginBottom: "20px",
  },
  homeButton: {
    padding: "10px 20px",
    backgroundColor: "white",
    color: "#6f3e76",
    border: "none",
    borderRadius: "5px",
    cursor: "pointer",
    fontSize: "16px",
    fontWeight: "bold",
  },
  rightPanel: {
    width: "45%",
    backgroundColor: "#fff",
    position: "relative",
  },
  curve: {
    position: "absolute",
    left: "-25%", // Giữ nguyên vị trí giữa 2 panel
    top: "35%", // Cố định vào lề trên
    transform: "translateX(-50%) rotate(90deg)", // Giữ nguyên xoay dọc
    width: "auto", // Để tránh zoom làm thay đổi kích thước
    height: "100%", // Luôn kéo dài theo chiều cao của `rightPanel`
    minWidth: "90px",
    minHeight: "100vh", // Giữ full màn hình
    overflow: "hidden",
    pointerEvents: "none",
    zIndex: 1,
  },
  formContainer: {
    position: "relative",
    zIndex: "2", // Đảm bảo nó hiển thị trên SVG
    backgroundColor: "#fff",
    padding: "30px 40px 30px 10px", // padding: top right bottom left
  },
  title: {
    textAlign: "center",
    fontWeight: "bold",
    marginBottom: "20px",
    marginTop:"-5px",
  },
  form: {
    display: "flex",
    flexDirection: "column",
  },
  button: {
    width: "50%",
    padding: "10px",
    backgroundColor: "#6f3e76",
    color: "white",
    border: "none",
    borderRadius: "5px",
    cursor: "pointer",
    fontSize: "16px",
    fontWeight: "bold",
    textTransform: "uppercase",
    marginTop: "15px",
  },

    // Style cho input
  inputContainerStyle: {
    position: "relative",
    marginBottom: "15px",
  },

  inputStyle: {
    paddingRight: "10px",
    width: "96%",
    padding: "12px",
    border: "1px solid #ccc",
    borderRadius: "5px",
    outline: "none",
  },

  placeholderStyle: {
    position: "absolute",
    left: "12px",
    top: "10px",
    color: "rgba(200, 200, 200, 0.3)",
    transition: "0.2s ease",
    pointerEvents: "none",
    borderRadius: "5px",
    backgroundColor: "white", // Làm nền cho placeholder để không bị viền che
    padding: "0 5px", // Tạo khoảng trống giữa placeholder và viền
    zIndex: 1, // Đặt trên input
  },

  focusedPlaceholderStyle: {
    top: "-8px",
    left: "10px",
    fontSize: "12px",
    fontWeight: "bold",
    color: "#6f3e76",
    backgroundColor: "white", // Giữ nguyên nền khi focus
    padding: "0 5px",
    zIndex: 1, // Đặt trên input
  },

  selectStyle: {
    width: "100%",
    padding: "12px",
    border: "1px solid #ccc",
    borderRadius: "5px",
    backgroundColor: "#fff",
    marginBottom: "10px",
  },
};

export default Signup;